using Horus.Domain.Findings.Vulnerabilities;
using Horus.Domain.Findings.Vulnerabilities.Evidences;
using Horus.Domain.Scanning.NetworkPorts;
using Horus.Domain.Tooling.Manifests.Identity;

namespace Horus.Tests.Unit.Domain.Findings.Vulnerabilities
{
	public class VulnerabilityTests
	{
		#region Constructor
		[Fact]
		public void Constructor_ShouldCreateVulnerability_WhenNoDescriptionIsProvided()
		{
			// Arrange
			var title = "Sample Vulnerability";
			var severity = VulnerabilitySeverity.Info;
			var networkPortId = new NetworkPortId();
			var sourceToolId = new ToolManifestId();

			// Act
			var vulnerability = Vulnerability.Create(title, networkPortId, sourceToolId, severity);

			// Assert
			Assert.NotNull(vulnerability);
			Assert.Equal(title, vulnerability.Title.Value);
			Assert.Equal(severity, vulnerability.Severity);
			Assert.Equal(networkPortId, vulnerability.PortId);
			Assert.Null(vulnerability.Description);
			Assert.Equal(sourceToolId, vulnerability.SourceToolId);
		}

		[Fact]
		public void Constructor_ShouldCreateVulnerability_WhenDescriptionIsProvided()
		{
			// Arrange
			var title = "Sample Vulnerability";
			var severity = VulnerabilitySeverity.High;
			var description = "This is a sample vulnerability description.";
			var networkPortId = new NetworkPortId();
			var sourceToolId = new ToolManifestId();

			// Act
			var vulnerability = Vulnerability.Create(title, networkPortId, sourceToolId, severity, description);

			// Assert
			Assert.NotNull(vulnerability);
			Assert.Equal(title, vulnerability.Title.Value);
			Assert.Equal(severity, vulnerability.Severity);
			Assert.Equal(networkPortId, vulnerability.PortId);
			Assert.NotNull(vulnerability.Description);
			Assert.Equal(description, vulnerability.Description!.Value);
			Assert.Equal(sourceToolId, vulnerability.SourceToolId);
		}

		[Fact]
		public void Constructor_ShouldCreateVulnerabilityWithDefaultSeverity_WhenNoSeverityIsProvided()
		{
			// Arrange
			var title = "Sample Vulnerability";
			var networkPortId = new NetworkPortId();
			var sourceToolId = new ToolManifestId();

			// Act
			var vulnerability = Vulnerability.Create(title, networkPortId, sourceToolId);

			// Assert
			Assert.NotNull(vulnerability);
			Assert.Equal(title, vulnerability.Title.Value);
			Assert.Equal(VulnerabilitySeverity.Info, vulnerability.Severity);
			Assert.Equal(networkPortId, vulnerability.PortId);
			Assert.Equal(sourceToolId, vulnerability.SourceToolId);
		}
		#endregion

		#region AddEvidence
		[Fact]
		public void AddEvidence_ShouldAddEvidenceToVulnerability()
		{
			// Arrange
			var sourceToolId = new ToolManifestId();
			var vulnerability = Vulnerability.Create("Sample Vulnerability", new NetworkPortId(), sourceToolId);
			var evidence = Evidence.Create("{ \"key\": \"value\" }");

			// Act
			vulnerability.AddEvidence(evidence);

			// Assert
			Assert.Contains(evidence, vulnerability.Evidences);
		}

		[Fact]
		public void AddEvidence_ShouldIncreaseEvidencesCount_WhenMultipleEvidencesAreAdded()
		{
			// Arrange
			var sourceToolId = new ToolManifestId();
			var vulnerability = Vulnerability.Create("Sample Vulnerability", new NetworkPortId(), sourceToolId);
			var evidence1 = Evidence.Create("{ \"key1\": \"value1\" }");
			var evidence2 = Evidence.Create("{ \"key2\": \"value2\" }");

			// Act
			vulnerability.AddEvidence(evidence1);
			vulnerability.AddEvidence(evidence2);

			// Assert
			Assert.Equal(2, vulnerability.Evidences.Count);
			Assert.Contains(evidence1, vulnerability.Evidences);
			Assert.Contains(evidence2, vulnerability.Evidences);
		}

		[Fact]
		public void AddEvidence_ShouldUpdateUpdatedAtTimestamp()
		{
			// Arrange
			var vulnerability = Vulnerability.Create("Sample Vulnerability", new NetworkPortId(), new ToolManifestId());
			var evidence = Evidence.Create("{ \"key\": \"value\" }");
			var initialUpdatedAt = vulnerability.UpdatedAt;

			// Act
			Thread.Sleep(50); // Ensure timestamp difference
			vulnerability.AddEvidence(evidence);

			// Assert
			Assert.True(vulnerability.UpdatedAt > initialUpdatedAt);
		}
		#endregion

		#region RemoveEvidence
		[Fact]
		public void RemoveEvidence_ShouldRemoveEvidenceFromVulnerability()
		{
			// Arrange
			var vulnerability = Vulnerability.Create("Sample Vulnerability", new NetworkPortId(), new ToolManifestId());
			var evidence = Evidence.Create("{ \"key\": \"value\" }");
			vulnerability.AddEvidence(evidence);
			Assert.Contains(evidence, vulnerability.Evidences);

			// Act
			vulnerability.RemoveEvidence(evidence);
			// Assert
			Assert.DoesNotContain(evidence, vulnerability.Evidences);
		}

		[Fact]
		public void RemoveEvidence_ShouldUpdateUpdatedAtTimestamp()
		{
			// Arrange
			var vulnerability = Vulnerability.Create("Sample Vulnerability", new NetworkPortId(), new ToolManifestId());
			var evidence = Evidence.Create("{ \"key\": \"value\" }");
			vulnerability.AddEvidence(evidence);
			var initialUpdatedAt = vulnerability.UpdatedAt;

			// Act
			Thread.Sleep(50); // Ensure timestamp difference
			vulnerability.RemoveEvidence(evidence);

			// Assert
			Assert.True(vulnerability.UpdatedAt > initialUpdatedAt);
		}
		#endregion

		#region UpdateDescription
		[Fact]
		public void UpdateDescription_ShouldUpdateVulnerabilityDescription()
		{
			// Arrange
			var vulnerability = Vulnerability.Create("Sample Vulnerability", new NetworkPortId(), new ToolManifestId());
			var newDescription = "Updated vulnerability description.";

			// Act
			vulnerability.UpdateDescription(newDescription);

			// Assert
			Assert.NotNull(vulnerability.Description);
			Assert.Equal(newDescription, vulnerability.Description!.Value);
		}
		[Fact]
		public void UpdateDescription_ShouldSetDescriptionToNull_WhenEmptyStringIsProvided()
		{
			// Arrange
			var vulnerability = Vulnerability.Create("Sample Vulnerability", new NetworkPortId(), new ToolManifestId(), description: "Initial description.");
			var newDescription = string.Empty;

			// Act
			vulnerability.UpdateDescription(newDescription);

			// Assert
			Assert.Null(vulnerability.Description);
		}
		[Fact]
		public void UpdateDescription_ShouldUpdateUpdatedAtTimestamp()
		{
			// Arrange
			var vulnerability = Vulnerability.Create("Sample Vulnerability", new NetworkPortId(), new ToolManifestId());
			var newDescription = "Updated vulnerability description.";
			var initialUpdatedAt = vulnerability.UpdatedAt;

			// Act
			Thread.Sleep(50); // Ensure timestamp difference
			vulnerability.UpdateDescription(newDescription);

			// Assert
			Assert.True(vulnerability.UpdatedAt > initialUpdatedAt);
		}
		#endregion

		#region Rename
		[Fact]
		public void Rename_ShouldUpdateVulnerabilityTitle()
		{
			// Arrange
			var vulnerability = Vulnerability.Create("Sample Vulnerability", new NetworkPortId(), new ToolManifestId());
			var newTitle = "Renamed Vulnerability";

			// Act
			vulnerability.Rename(newTitle);

			// Assert
			Assert.Equal(newTitle, vulnerability.Title.Value);
		}

		[Fact]
		public void Rename_ShouldUpdateUpdatedAtTimestamp()
		{
			// Arrange
			var vulnerability = Vulnerability.Create("Sample Vulnerability", new NetworkPortId(), new ToolManifestId());
			var newTitle = "Renamed Vulnerability";
			var initialUpdatedAt = vulnerability.UpdatedAt;

			// Act
			Thread.Sleep(50); // Ensure timestamp difference
			vulnerability.Rename(newTitle);

			// Assert
			Assert.True(vulnerability.UpdatedAt > initialUpdatedAt);
		}
		#endregion
	}
}