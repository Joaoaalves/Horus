using Horus.Domain.Findings.Vulnerabilities.Evidences;
using Horus.Domain.Scanning.NetworkPorts;
using Horus.Domain.SeedWork;
using Horus.Domain.SharedKernel.EntityDescriptions;
using Horus.Domain.SharedKernel.EntityNames;
using Horus.Domain.Tooling.Manifests;
using Horus.Domain.Tooling.Manifests.Identity;

namespace Horus.Domain.Findings.Vulnerabilities
{
	public sealed class Vulnerability : Entity
	{
		// Attributes
		public VulnerabilityId Id { get; } = default!;
		public EntityName Title { get; private set; } = default!;
		public EntityDescription? Description { get; private set; } = default!;
		public VulnerabilitySeverity Severity { get; private set; }
		public List<Evidence> Evidences { get; private set; } = [];
		public DateTime CreatedAt { get; } = DateTime.UtcNow;
		public DateTime UpdatedAt { get; private set; } = DateTime.UtcNow;

		// Relations
		public NetworkPortId PortId { get; private set; } = default!;
		public NetworkPort Port { get; private set; } = default!;
		public ToolManifestId SourceToolId { get; private set; } = default!;
		public ToolManifest SourceTool { get; private set; } = default!;


		// For EF
		[Obsolete("For EF Only", true)]
		private Vulnerability() { }

		private Vulnerability(
			VulnerabilityId id,
			EntityName title,
			ToolManifestId sourceToolId,
			NetworkPortId portId,
			VulnerabilitySeverity severity,
			EntityDescription? description = null)
		{
			Id = id;
			Title = title;
			Severity = severity;
			PortId = portId;
			Description = description;
			SourceToolId = sourceToolId;
		}

		public static Vulnerability Create(
			string title,
			NetworkPortId portId,
			ToolManifestId sourceToolId,
			VulnerabilitySeverity severity = VulnerabilitySeverity.Info,
			string? description = null)
		{
			var vulnTitle = EntityName.FromString(title);
			EntityDescription? vulnDescription = null;

			if (description is not null)
			{
				vulnDescription = EntityDescription.Create(description.Trim());
			}

			return new Vulnerability(
				new VulnerabilityId(),
				vulnTitle,
				sourceToolId,
				portId,
				severity,
				vulnDescription
			);
		}

		public void AddEvidence(Evidence evidence)
		{
			Evidences.Add(evidence);
			MarkUpdated();
		}

		public void RemoveEvidence(Evidence evidence)
		{
			Evidences.Remove(evidence);
			MarkUpdated();
		}

		private void MarkUpdated()
		{
			UpdatedAt = DateTime.UtcNow;
		}

		public void UpdateSeverity(VulnerabilitySeverity severity)
		{
			Severity = severity;
		}

		public void UpdateDescription(string description)
		{

			if (string.IsNullOrWhiteSpace(description))
			{
				Description = null;
			}
			else
			{
				var vulnDescription = EntityDescription.Create(description);
				Description = vulnDescription;
			}

			MarkUpdated();
		}

		public void Rename(string title)
		{
			var vulnTitle = EntityName.FromString(title);
			Title = vulnTitle;
			MarkUpdated();
		}
	}
}